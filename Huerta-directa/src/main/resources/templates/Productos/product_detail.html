<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title th:text="${producto.nameProduct}">Detalle del producto</title>
    <link rel="icon" type="image/png" href="/images/logo_huerta.png" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/productos.css}" />
    <link rel="stylesheet" href="/CSS/stylePrincipal.css" />
    <link rel="stylesheet" href="/CSS/darkindex.css" />
    <link rel="stylesheet" href="/CSS/styleCategorias.css" />
    <link href="/CSS/output.css" rel="stylesheet" />
    <!--agregacion para los iconos-->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined"
    />
  </head>
  <body>
    <!-- HEADER -->
    <!--<div th:replace="fragments/header-context :: header-content"></div>-->

    <!-- BREADCRUMB -->
    <div class="laypout-container">
      <div th:replace="fragments/navPagina :: navPagina"></div>
      <nav class="breadcrumb">
        <div th:replace="fragments/carritoProducto :: carritoProducto"></div>
      </nav>
    </div>

    <main class="container1 detalle-producto">
      <div class="detalle-grid">
        <!-- COLUMNA IZQUIERDA - GALER√çA -->
        <div class="galeria">
          <!-- Imagen principal con zoom hover -->
          <div class="imagen-principal-wrapper">
            <div class="badge-nuevo">Nuevo</div>
            <div class="badge-organico">100% Org√°nico</div>
            <div class="imagen-principal">
              <img
                th:src="@{'/images/productos/' + ${producto.imageProduct}}"
                th:alt="${producto.nameProduct}"
                class="producto-img-zoom"
              />
            </div>
          </div>

          <!-- Miniaturas -->
          <div class="galeria-miniaturas" th:if="${producto.images != null and !producto.images.isEmpty()}">
            <!-- Miniatura imagen principal -->
            <div class="miniatura activa" th:onclick="cambiarImagenPrincipal([[${'/images/productos/' + producto.imageProduct}]])">
              <img
                th:src="@{'/images/productos/' + ${producto.imageProduct}}"
                th:alt="${producto.nameProduct}"
              />
            </div>
            <!-- Miniaturas adicionales -->
            <div class="miniatura" th:each="img : ${producto.images}" th:onclick="cambiarImagenPrincipal([[${'/images/productos/' + img}]])">
              <img
                th:src="@{'/images/productos/' + ${img}}"
                th:alt="${producto.nameProduct}"
              />
            </div>
          </div>
        </div>

        <!-- COLUMNA DERECHA - INFORMACI√ìN -->
        <div class="info">
          <!-- Encabezado del producto -->
          <div class="producto-header">
            <span class="categoria-tag">Verduras Frescas</span>
            <h1 class="producto-titulo" th:text="${producto.nameProduct}">
              Nombre del producto
            </h1>

            <div class="producto-rating">
              <div class="estrellas">
                <span class="estrella activa">‚òÖ</span>
                <span class="estrella activa">‚òÖ</span>
                <span class="estrella activa">‚òÖ</span>
                <span class="estrella activa">‚òÖ</span>
                <span class="estrella">‚òÖ</span>
              </div>
                <span class="rating-texto" th:text="'(' + ${#lists.size(comments)} + ') rese√±as'"> (4.0) 127 rese√±as</span>
            </div>
          </div>

          <!-- Precio destacado -->
          <div class="precio-section">
            <div class="precio-principal">
              <span
                class="precio-actual"
                th:text="'$' + ${#numbers.formatDecimal(producto.price, 0, 'COMMA', 0, 'POINT')}"
                >$4,200</span
              >
            </div>
          </div>

          <!-- Descripci√≥n -->
          <div class="descripcion-section">
            <h3 class="seccion-titulo">Descripci√≥n</h3>
            <p
              class="producto-descripcion"
              th:text="${producto.descriptionProduct}"
            >
              Descripci√≥n detallada del producto. Productos frescos directamente
              de la huerta, cultivados de forma org√°nica y sostenible.
            </p>
          </div>

          <!-- Caracter√≠sticas destacadas -->
          <div class="caracteristicas-grid">
            <div class="caracteristica-item">
              <div class="caracteristica-icon">üå±</div>
              <div class="caracteristica-texto">
                <strong>100% Org√°nico</strong>
                <span>Sin pesticidas</span>
              </div>
            </div>
            <div class="caracteristica-item">
              <div class="caracteristica-icon">üöö</div>
              <div class="caracteristica-texto">
                <strong>Env√≠o r√°pido</strong>
                <span>24-48 horas</span>
              </div>
            </div>
            <div class="caracteristica-item">
              <div class="caracteristica-icon">‚ùÑÔ∏è</div>
              <div class="caracteristica-texto">
                <strong>S√∫per fresco</strong>
                <span>Reci√©n cosechado</span>
              </div>
            </div>
            <div class="caracteristica-item">
              <div class="caracteristica-icon">‚úì</div>
              <div class="caracteristica-texto">
                <strong>Certificado</strong>
                <span>Calidad garantizada</span>
              </div>
            </div>
          </div>

          <!-- Caja de compra mejorada -->
          <div class="compra-box">
            <div class="stock-info">
              <div th:if="${producto.stock != null and producto.stock > 0}" class="stock-disponible">
                <span class="stock-icon">‚úì</span>
                <span class="stock-texto">Stock disponible</span>
              </div>
              <div th:if="${producto.stock == null or producto.stock == 0}" class="stock-agotado">

                <span class="stock-texto">Sin stock</span>
              </div>
              <span
                th:if="${producto.stock != null and producto.stock > 0}"
                class="unidades-disponibles"
                th:text="${producto.stock + ' unidades disponibles'}"
                >67 unidades disponibles</span>
              <span
                th:if="${producto.stock == null or producto.stock == 0}"
                class="unidades-disponibles"
                style="color: #dc3545;">Producto agotado</span>
            </div>

            <!-- Selector de cantidad (OCULTO A PETICION DEL USUARIO) -->
            <div class="cantidad-selector" style="display: none;">
              <div class="cantidad-controls">
                <button type="button" class="btn-cantidad" onclick="ajustarCantidadDetalle(-1)">-</button>
                <input
                  type="number"
                  id="cantidad"
                  class="cantidad-input"
                  value="1"
                  min="1"
                  th:max="${producto.stock}"
                  readonly
                />
                <button
                  type="button"
                  class="btn-cantidad"
                  onclick="ajustarCantidadDetalle(1)"
                  th:data-max-stock="${producto.stock}"
                >
                  +
                </button>
              </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="botones-accion" th:if="${producto.stock != null and producto.stock > 0}">
              <form
                th:action="@{/producto/{id}(id=${producto.idProduct})}"
                method="post"
              >
                <input
                  type="hidden"
                  name="productId"
                  th:value="${producto.idProduct}"
                />
                <input
                  type="hidden"
                  name="cantidad"
                  id="cantidadForm"
                  value="1"
                />
                <button type="button" class="btn-2" 
                    th:onclick="crearPagoDetalle([[${producto.idProduct}]], [[${producto.nameProduct}]], [[${producto.price}]], '/images/productos/' + [[${producto.imageProduct}]])">
                  Ir a pagar
                </button>
              </form>
              <div class="btnProducto">
                <button
                  type="button"
                  class="agregar-carrito btn-2 botonIcono"
                  th:onclick="agregarAlCarritoDesdeDetalle([[${producto.idProduct}]], [[${producto.nameProduct}]], [[${producto.price}]], '/images/productos/' + [[${producto.imageProduct}]])"
                  ><span class="material-symbols-outlined iconAgregar">
                    add_shopping_cart
                  </span>
                  Agregar</button>
              </div>
            </div>

            <!-- Mensaje cuando no hay stock -->
            <div class="botones-sin-stock" th:if="${producto.stock == null or producto.stock == 0}">
              <button class="btn-2 btn-disabled" disabled style="background-color: #6b7280 !important; cursor: not-allowed; opacity: 0.7;">
                <span class="material-symbols-outlined">block</span>
                Producto agotado
              </button>
            </div>

              </div>
            </div>

            <!-- Informaci√≥n adicional -->
            <div class="extra-info">
              <div class="info-item">
                <span class="info-icon">üöö</span>
                <div class="info-texto">
                  <strong>Env√≠o gratis</strong>
                  <span>En compras superiores a $50.000</span>
                </div>
              </div>
              <div class="info-item">
                <span class="info-icon">‚Ü©Ô∏è</span>
                <div class="info-texto">
                  <strong>Devoluci√≥n gratis</strong>
                  <span>Dentro de 30 d√≠as</span>
                </div>
              </div>
              <div class="info-item">
                <span class="info-icon">üîí</span>
                <div class="info-texto">
                  <strong>Compra protegida</strong>
                  <span>Por Huerta Directa</span>
                </div>
              </div>
            </div>

            <!-- M√©todos de pago -->
            <div class="metodos-pago">
              <h4>M√©todos de pago aceptados:</h4>
              <div class="pago-icons">
                <span class="pago-icon">üí≥</span>
                <span class="pago-icon">üí∞</span>
                <span class="pago-icon">üì±</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SECCI√ìN ADICIONAL: Informaci√≥n detallada -->
      <div class="informacion-tabs">
        <div class="tabs-header">
          <button class="tab-btn active" onclick="cambiarTab('detalles')">
            Detalles del producto
          </button>
          <button class="tab-btn" onclick="cambiarTab('beneficios')">
            Beneficios
          </button>
          <button class="tab-btn" onclick="cambiarTab('conservacion')">
            Conservaci√≥n
          </button>
          <button class="tab-btn" onclick="cambiarTab('resenas')">
            Rese√±as (<span th:text="${#lists.size(comments)}">0</span>)
          </button>
        </div>

        <div class="tabs-content">
          <div id="detalles" class="tab-panel active">
            <h3>Detalles del producto</h3>
            <ul class="lista-detalles">
              <li><strong>Origen:</strong> Huerta local certificada</li>
              <li><strong>Peso aproximado:</strong> 500g - 1kg</li>
              <li><strong>Tiempo de cosecha:</strong> Menos de 24 horas</li>
              <li><strong>Certificaci√≥n:</strong> Org√°nico certificado</li>
              <li><strong>Vida √∫til:</strong> 7-10 d√≠as en refrigeraci√≥n</li>
            </ul>
          </div>

          <div id="beneficios" class="tab-panel">
            <h3>Beneficios para tu salud</h3>
            <p>
              Este producto ofrece m√∫ltiples beneficios para tu bienestar y
              nutrici√≥n.
            </p>
          </div>

          <div id="conservacion" class="tab-panel">
            <h3>Consejos de conservaci√≥n</h3>
            <p>
              Para mantener la frescura del producto, te recomendamos
              almacenarlo en el refrigerador.
            </p>
          </div>

          <div id="resenas" class="tab-panel">
            <h3 style="margin-bottom: 25px; font-size: 1.5rem; color: #1f2937;">Rese√±as de clientes</h3>

            <!-- Formulario de rese√±a  -->
            <div class="form-resena" style="margin-bottom: 30px; padding: 25px 20px; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05); max-width: 100%;">
    <h4 style="margin-bottom: 15px; color: #374151; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 1.3rem;"></span>
        Escribe tu opini√≥n
    </h4>
                <form action="/comment/add" method="post" style="width: 100%;">
                    <input type="hidden" name="productId" th:value="${producto.idProduct}" />
                    <div style="margin-bottom: 12px; width: 100%;">
                        <textarea
                            name="commentCommenter"
                            rows="8"
                            placeholder="Comparte tu experiencia con este producto... ¬øQu√© te pareci√≥? ¬øLo recomendar√≠as?"
                            required
                            style="width: 100%; min-height: 180px; padding: 15px 20px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical; transition: all 0.3s ease; background: white; display: block; box-sizing: border-box;"
                            onfocus="this.style.borderColor='#8bc34a'; this.style.boxShadow='0 0 0 3px rgba(139,195,74,0.1)'"
                            onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                        ></textarea>
                    </div>
                    <div style="text-align: left;">
                        <button type="submit" style="font-size: 0.85rem; padding: 8px 16px; background: #8bc34a; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-block;">
                            üìù Publicar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Mensaje cuando no hay rese√±as -->
            <div th:if="${#lists.isEmpty(comments)}" class="no-resenas" style="text-align: center; padding: 40px 20px; background: #f9fafb; border-radius: 12px; border: 2px dashed #d1d5db;">
               <p style="color: #6b7280; font-size: 1rem; margin: 0;">
                   <span style="font-size: 2rem; display: block; margin-bottom: 10px;">üí¨</span>
                   A√∫n no hay rese√±as para este producto.<br/>
                   <strong style="color: #8bc34a;">¬°S√© el primero en opinar!</strong>
               </p>
            </div>

            <!-- Lista de rese√±as mejorada -->
            <div th:each="comment : ${comments}" class="review-item" style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.04)'; this.style.transform='translateY(0)'">
                <div class="review-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <!-- Avatar del usuario -->
                    <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #8bc34a 0%, #689f38 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <span th:text="${#strings.substring(comment.nameCommenter, 0, 1).toUpperCase()}">U</span>
                    </div>
                    <div style="flex: 1;">
                        <strong th:text="${comment.nameCommenter}" style="color: #1f2937; font-size: 1rem; display: block; margin-bottom: 2px;">Usuario</strong>
                        <span class="review-date" th:text="${#temporals.format(comment.creationComment, 'dd/MM/yyyy')}" style="color: #9ca3af; font-size: 0.85rem; display: flex; align-items: center; gap: 4px;">
                            <span style="font-size: 0.9rem;">üìÖ</span>
                            Fecha
                        </span>
                    </div>
                    <!-- Estrellas decorativas -->
                    <div style="color: #fbbf24; font-size: 1rem;">
                        ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                    </div>
                </div>
                <div class="review-body" style="padding-left: 57px;">
                    <p th:text="${comment.commentCommenter}" style="color: #4b5563; line-height: 1.6; margin: 0; font-size: 0.95rem;">Comentario...</p>
                </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SECCI√ìN: Productos relacionados -->
      <div class="productos-relacionados">
        <h2 class="seccion-titulo-principal">Tambi√©n te puede interesar</h2>
        <div class="productos-grid">
          <!-- Aqu√≠ ir√≠an productos relacionados -->
          <div class="producto-card-mini">
            <p class="texto-placeholder">
              Productos relacionados aparecer√°n aqu√≠
            </p>
          </div>
        </div>
      </div>
    </main>

    <!-- FOOTER -->
    <div class="flex w-full justify-center items-center bg-[#8bc34a]">
      <div th:replace="fragments/footer :: footer"></div>
    </div>

    <script>
      // ==========================================
      // L√≥gica espec√≠fica del Detalle de Producto
      // ==========================================

      // 1. Manejo de Cantidad (Renombrado para evitar conflictos con script.js)
      function ajustarCantidadDetalle(delta) {
        const input = document.getElementById("cantidad");
        const formInput = document.getElementById("cantidadForm");
        const btnMas = document.querySelector('.btn-cantidad[onclick*="1"]');

        // Obtener stock m√°ximo
        let maxStock = 99;
        if (btnMas) {
             const dataMax = btnMas.getAttribute('data-max-stock');
             if (dataMax) maxStock = parseInt(dataMax);
        }

        let valor = parseInt(input.value) || 1;
        let nuevoValor = valor + delta;

        // Validar l√≠mites
        if (nuevoValor < 1) nuevoValor = 1;
        if (nuevoValor > maxStock) {
            nuevoValor = maxStock;
            if (delta > 0) mostrarMensajeLimite(maxStock);
        }

        input.value = nuevoValor;
        if (formInput) formInput.value = nuevoValor;
      }

      function mostrarMensajeLimite(maxStock) {
        let mensaje = document.getElementById('mensaje-limite');
        if (!mensaje) {
          mensaje = document.createElement('div');
          mensaje.id = 'mensaje-limite';
          mensaje.style.cssText = 'color: #dc3545; font-size: 12px; margin-top: 5px; text-align: center;';
          document.querySelector('.cantidad-selector')?.appendChild(mensaje);
        }
        mensaje.textContent = `Solo hay ${maxStock} unidades disponibles`;
        setTimeout(() => mensaje?.remove(), 3000);
      }

      // 2. Integraci√≥n con el Carrito de script.js
      // Construye el objeto producto y usa la funci√≥n global agregarAlCarrito(producto) de script.js
      function agregarAlCarritoDesdeDetalle(idProducto, nombre, precio, imagen) {
        const cantidadInput = document.getElementById("cantidad");
        const cantidad = parseInt(cantidadInput.value) || 1;

        const infoElemento = {
            id: idProducto.toString(), // script.js maneja IDs como strings en data attributes
            nombre: nombre,
            precio: parseFloat(precio),
            imagen: imagen,
            cantidad: cantidad
        };

        console.log("üì¶ Agregando desde detalle:", infoElemento);

        // Llamar a la funci√≥n del script.js global
        if (typeof agregarAlCarrito === 'function') {
            agregarAlCarrito(infoElemento);
        } else {
            console.error("‚ùå Error: script.js no cargado correctamente (agregarAlCarrito no existe)");
            alert("Error interno: No se pudo agregar al carrito.");
        }
      }

      // 3. Funci√≥n "Ir a Pagar" (Comprar ahora)
      function crearPagoDetalle(idProducto, nombre, precio, imagen) {
        // 1. Agregar al carrito
        agregarAlCarritoDesdeDetalle(idProducto, nombre, precio, imagen);

        // 2. Proceder al pago (funci√≥n de script.js)
        setTimeout(() => {
            if (typeof procederAlPago === 'function') {
                procederAlPago();
            } else {
                console.log("‚ÑπÔ∏è Redirigiendo a resumen manualmente...");
                window.location.href = "/carrito/resumen";
            }
        }, 500); // Peque√±o delay para asegurar actualizaci√≥n de localStorage
      }
      
      // 4. Cambiar Imagen Principal
      function cambiarImagenPrincipal(src) {
        const mainImage = document.querySelector('.producto-img-zoom');
        if(mainImage) {
            mainImage.src = src;
        }
        // Actualizar clase activa en miniaturas
        document.querySelectorAll('.miniatura').forEach(m => m.classList.remove('activa'));
        event.currentTarget.classList.add('activa');
      }

      // Script para tabs (sin cambios)
      function cambiarTab(tabId) {
        document.querySelectorAll(".tab-btn").forEach((btn) => btn.classList.remove("active"));
        document.querySelectorAll(".tab-panel").forEach((panel) => panel.classList.remove("active"));
        // Buscar el bot√≥n correspondiente
        const btn = Array.from(document.querySelectorAll(".tab-btn")).find(b => b.textContent.includes(tabId) || b.onclick.toString().includes(tabId));
        if(btn) btn.classList.add("active");
        
        // Fallback simple si no encuentra por texto
        event.target.classList.add("active");
        
        document.getElementById(tabId).classList.add("active");
      }
    </script>
    <script src="/JS/script.js"></script>
  </body>
</html>
