<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Usuarios - Huerta Directa</title>
    <link rel="icon" type="image/png" href="/images/logo_huerta.png"/>
    <link rel="stylesheet" href="/CSS/StyleDashBoardd.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <section class="consulta-wrapper">
        <div class="consulta-container">
            <h1><i class="fas fa-users"></i> CONSULTA DE USUARIOS</h1>
            
            <!-- Formulario de búsqueda -->
            <form action="/consulta_usuarios" method="get">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="dato" class="form-label">Filtro de búsqueda</label>
                        <select name="dato" id="dato" class="form-select" required>
                            <option value="id" th:selected="${datoSeleccionado == 'id'}">ID</option>
                            <option value="name_user" th:selected="${datoSeleccionado == 'name_user'}">Nombre</option>
                            <option value="email" th:selected="${datoSeleccionado == 'email'}">Correo</option>
                            <option value="role" th:selected="${datoSeleccionado == 'role'}">Rol</option>
                        </select>
                    </div>
                    
                    <div class="col-md-5">
                        <label for="valor" class="form-label">Valor a consultar</label>
                        <input name="valor" type="text" class="form-control" id="valor" 
                               th:value="${valorBuscado}" placeholder="Ingrese el valor...">
                    </div>
                    
                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <a href="/consulta_usuarios" class="btn btn-secondary">
                            <i class="fas fa-list"></i> Ver Todos
                        </a>
                    </div>
                </div>
            </form>

            <hr>

            <!-- Botones de exportación -->
            <div class="export-section">
                <h5>Exportar Datos</h5>
                <button onclick="exportarUsuariosExcel()" class="btn btn-success">
                    <i class="fas fa-file-excel"></i> Exportar a Excel
                </button>
                <button onclick="exportarUsuariosPDF()" class="btn btn-danger">
                    <i class="fas fa-file-pdf"></i> Exportar a PDF
                </button>
            </div>

            <hr>

            <!-- Tabla de resultados -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${usuarios == null || usuarios.isEmpty()}">
                            <td colspan="5" class="text-center">
                                <i class="fas fa-info-circle"></i> No se encontraron usuarios
                            </td>
                        </tr>
                        <tr th:each="usuario : ${usuarios}">
                            <td th:text="${usuario.id}"></td>
                            <td th:text="${usuario.name}"></td>
                            <td th:text="${usuario.email}"></td>
                            <td>
                                <span th:if="${usuario.idRole == 1}" class="badge bg-danger">Admin</span>
                                <span th:if="${usuario.idRole == 2}" class="badge bg-primary">Cliente</span>
                                <span th:if="${usuario.idRole != 1 && usuario.idRole != 2}" 
                                      class="badge bg-secondary">Otro</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-warning" 
                                            th:onclick="'editarUsuario(' + ${usuario.id} + ')'">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" 
                                            th:onclick="'eliminarUsuario(' + ${usuario.id} + ')'">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Botón para volver -->
            <div class="text-center mt-4">
                <a href="/DashboardAdmin" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </section>

    <script>
        // Función para cambiar entre input de texto y select según el filtro
        function toggleValorInput() {
            const dato = document.getElementById('dato').value;
            const valorTexto = document.getElementById('valorTexto');
            const valorRol = document.getElementById('valorRol');
            
            if (dato === 'role') {
                valorTexto.style.display = 'none';
                valorRol.style.display = 'block';
                valorTexto.removeAttribute('name');
                valorRol.setAttribute('name', 'valor');
                valorRol.required = true;
                valorTexto.required = false;
            } else {
                valorTexto.style.display = 'block';
                valorRol.style.display = 'none';
                valorRol.removeAttribute('name');
                valorTexto.setAttribute('name', 'valor');
                valorTexto.required = true;
                valorRol.required = false;
            }
        }
        
        // Ejecutar al cargar la página para mantener el estado correcto
        document.addEventListener('DOMContentLoaded', function() {
            toggleValorInput();
        });

        function exportarUsuariosExcel() {
            const params = new URLSearchParams(window.location.search);
            window.location.href = `/api/users/exportExcel?${params.toString()}`;
        }

        function exportarUsuariosPDF() {
            const params = new URLSearchParams(window.location.search);
            window.location.href = `/api/users/exportPdf?${params.toString()}`;
        }

        function editarUsuario(id) {
            // Implementar lógica de edición
            alert('Funcionalidad de edición en desarrollo para usuario ID: ' + id);
        }

        function eliminarUsuario(id) {
            if (confirm('¿Está seguro de eliminar este usuario?')) {
                fetch(`/api/users/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Usuario eliminado exitosamente');
                        window.location.reload();
                    } else {
                        alert('Error al eliminar usuario');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al eliminar usuario');
                });
            }
        }
    </script>
</body>
</html>