<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Usuarios - Huerta Directa</title>
    <link rel="icon" type="image/png" href="/images/logo_huerta.png"/>
    <link rel="stylesheet" href="/CSS/StyleDashBoardd.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Estilos para el modal email */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            animation: fadeIn 0.3s;
        }

        /*Estilos para el modal Cargar datos*/
        .modalOverlayCarga{
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            animation: fadeIn 0.3s;
        }

        .modalOverlayCarga.active {
            display: block;
        }

        .modal-carga {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            z-index: 9999;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }

        .modal-carga.active {
            display: block;
        }

        .modal-email {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .modal-email.active,
        .modal-overlay.active {
            display: block;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #689f38;
        }

        .modal-header h2 {
            color: #689f38;
            margin: 0;
            font-size: 24px;
        }

        .btn-close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .btn-close-modal:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #689f38;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .recipient-type {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .recipient-type label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .recipient-type input[type="radio"] {
            margin-right: 8px;
            width: auto;
        }

        .recipient-type label:has(input:checked) {
            background: #689f38;
            color: white;
            border-color: #689f38;
        }

        .btn-send-email {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #689f38, #8bc34a);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-send-email:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(104, 159, 56, 0.4);
        }

        .btn-send-email:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #689f38;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-message {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }

        .result-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result-message.active {
            display: block;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .btn-email-masivo {
            background: #8dc84b;
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-email-masivo:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(104, 159, 56, 0.4);
        }

        .export-section {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

    </style>
    </style>
</head>
<body>
    <section class="consulta-wrapper">
        <div class="consulta-container">
            <h1><i class="fas fa-users"></i> CONSULTA DE USUARIOS</h1>

            <!-- Formulario de b√∫squeda -->
            <form action="/consulta_usuarios" method="get">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="dato" class="form-label">Filtro de b√∫squeda</label>
                        <select name="dato" id="dato" class="form-select" required>
                            <option value="id" th:selected="${datoSeleccionado == 'id'}">ID</option>
                            <option value="name_user" th:selected="${datoSeleccionado == 'name_user'}">Nombre</option>
                            <option value="email" th:selected="${datoSeleccionado == 'email'}">Correo</option>
                            <option value="role" th:selected="${datoSeleccionado == 'role'}">Rol</option>
                        </select>
                    </div>

                    <div class="col-md-5">
                        <label for="valor" class="form-label">Valor a consultar</label>
                        <input name="valor" type="text" class="form-control" id="valor"
                               th:value="${valorBuscado}" placeholder="Ingrese el valor...">
                    </div>

                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <a href="/consulta_usuarios" class="btn btn-secondary">
                            <i class="fas fa-list"></i> Ver Todos
                        </a>
                    </div>
                </div>
            </form>

            <hr>

            <!-- Botones de exportaci√≥n y correo masivo -->
            <div class="export-section">
                <h5>Exportar Datos:</h5>
                <button onclick="exportarUsuariosExcel()" class="btn btn-success">
                    <i class="fas fa-file-excel"></i> Exportar a Excel
                </button>
                <button onclick="exportarUsuariosPDF()" class="btn btn-danger">
                    <i class="fas fa-file-pdf"></i> Exportar a PDF
                </button>
                <button onclick="abrirModalEmail()" class="btn-email-masivo">
                    <i class="fas fa-envelope"></i> Enviar Correo Masivo
                </button>
                <button onclick="abrirModalCargaDatos()" class="btn-email-masivo">
                    <i class="fas fa-cargar"></i> Cargar Datos
                </button>
            </div>

            <hr>

            <!-- Tabla de resultados -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${usuarios == null || usuarios.isEmpty()}">
                            <td colspan="5" class="text-center">
                                <i class="fas fa-info-circle"></i> No se encontraron usuarios
                            </td>
                        </tr>
                        <tr th:each="usuario : ${usuarios}">
                            <td th:text="${usuario.name}"></td>
                            <td th:text="${usuario.email}"></td>
                            <td>
                                <span th:if="${usuario.idRole == 1}" class="badge bg-danger">Admin</span>
                                <span th:if="${usuario.idRole == 2}" class="badge bg-primary">Cliente</span>
                                <span th:if="${usuario.idRole != 1 && usuario.idRole != 2}"
                                      class="badge bg-secondary">Otro</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-warning" 
                                            th:onclick="'editarUsuario(' + ${usuario.id} + ')'">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" 
                                            th:onclick="'eliminarUsuario(' + ${usuario.id} + ')'">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Bot√≥n para volver -->
            <div class="text-center mt-4">
                <a href="/DashboardAdmin" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </section>

    <!-- Modal de env√≠o de correo -->
    <div class="modal-overlay" id="modalOverlay" onclick="cerrarModalEmail()"></div>
    <div class="modal-email" id="modalEmail">
        <div class="modal-header">
            <h2><i class="fas fa-paper-plane"></i> Enviar Correo Masivo</h2>
            <button class="btn-close-modal" onclick="cerrarModalEmail()">&times;</button>
        </div>

        <form id="formEmailMasivo" onsubmit="enviarCorreoMasivo(event)">
            <div class="form-group">
                <label>Destinatarios:</label>
                <div class="recipient-type">
                    <label>
                        <input type="radio" name="tipoDestinatario" value="todos" checked>
                        Todos los usuarios
                    </label>
                    <label>
                        <input type="radio" name="tipoDestinatario" value="admins">
                        Solo Administradores
                    </label>
                    <label>
                        <input type="radio" name="tipoDestinatario" value="clientes">
                        Solo Clientes
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label for="asuntoEmail">
                    <i class="fas fa-heading"></i> Asunto del correo:
                </label>
                <input type="text" id="asuntoEmail" name="subject" required 
                       placeholder="Ej: Novedades en Huerta Directa">
            </div>

            <div class="form-group">
                <label for="cuerpoEmail">
                    <i class="fas fa-align-left"></i> Mensaje:
                </label>
                <textarea id="cuerpoEmail" name="body" required 
                          placeholder="Escribe tu mensaje aqu√≠...&#10;&#10;Puedes usar {{nombre}} para personalizar con el nombre del usuario"></textarea>
                <div class="help-text">
                    üí° Tip: Usa <strong>{{nombre}}</strong> en el mensaje para personalizarlo con el nombre de cada usuario
                </div>
            </div>

            <button type="submit" class="btn-send-email" id="btnEnviar">
                <i class="fas fa-paper-plane"></i> Enviar Correos
            </button>
        </form>

        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #666;">Enviando correo masivo, por favor espera...</p>
        </div>

        <div class="result-message" id="resultMessage"></div>
    </div>

    <!-- Modal de carga de datos -->
    <div class="modalOverlayCarga" id="modalOverlayCarga" onclick="cerrarModalCargaDatos()"></div>
    <div class="modal-carga" id="modalCargaDatos">
        <div class="modal-header">
            <h2><i class="fas fa-upload"></i> Cargar Datos</h2>
            <button class="btn-close-modal" onclick="cerrarModalCargaDatos()">&times;</button>
        </div>

        <form th:action="@{/api/users/archivo}"
              th:method="post"
              id="formCargaDatos"
              enctype="multipart/form-data"
              onsubmit="cargarDatos(event)">
            <div class="form-group">
                <label for="archivoCargaDatos">
                    <i class="fas fa-file"></i> Seleccionar archivo:
                </label>
                <input type="file" id="archivoCargaDatos" name="archivo"
                       accept=".csv,.xlsx,.xls" required
                       placeholder="Seleccione un archivo">
                <div class="help-text">
                    üí° Formatos soportados: CSV, Excel (.xlsx, .xls)
                </div>
            </div>

            <button type="submit" class="btn-send-email" id="btnCargarDatos">
                <i class="fas fa-upload"></i> Cargar Datos
            </button>
        </form>

        <div class="loading-spinner" id="loadingCarga">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #666;">Cargando datos, por favor espera...</p>
        </div>

        <div class="result-message" id="resultCarga"></div>
    </div>
    <script>
        // Funci√≥n para abrir el modal de email
        function abrirModalEmail() {
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('modalEmail').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Funci√≥n para cerrar el modal
        function cerrarModalEmail() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('modalEmail').classList.remove('active');
            document.body.style.overflow = 'auto';
            
            // Limpiar formulario y mensajes
            document.getElementById('formEmailMasivo').reset();
            document.getElementById('resultMessage').classList.remove('active', 'success', 'error');
            document.getElementById('loadingSpinner').classList.remove('active');
            document.getElementById('formEmailMasivo').style.display = 'block';
        }

        // Funci√≥n para abrir el modal de cargar datos
        function abrirModalCargaDatos() {
            document.getElementById('modalOverlayCarga').classList.add('active');
            document.getElementById('modalCargaDatos').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Funci√≥n para cerrar el modal de carga de datos
        function cerrarModalCargaDatos() {
            document.getElementById('modalOverlayCarga').classList.remove('active');
            document.getElementById('modalCargaDatos').classList.remove('active');
            document.body.style.overflow = 'auto';

            // Limpiar formulario y mensajes
            document.getElementById('formCargaDatos').reset();
            document.getElementById('resultCarga').classList.remove('active', 'success', 'error');
            document.getElementById('loadingCarga').classList.remove('active');
            document.getElementById('formCargaDatos').style.display = 'block';
        }

        // Funci√≥n para enviar correo masivo
        async function enviarCorreoMasivo(event) {
            event.preventDefault();

            const form = event.target;
            const btnEnviar = document.getElementById('btnEnviar');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultMessage = document.getElementById('resultMessage');
            const tipoDestinatario = document.querySelector('input[name="tipoDestinatario"]:checked').value;

            // Preparar datos
            const data = {
                subject: form.subject.value,
                body: form.body.value
            };

            // Determinar endpoint seg√∫n tipo de destinatario
            let endpoint = '/api/users/send-bulk-email';
            
            if (tipoDestinatario === 'admins') {
                endpoint = '/api/users/send-bulk-email-by-role';
                data.idRole = 1;
            } else if (tipoDestinatario === 'clientes') {
                endpoint = '/api/users/send-bulk-email-by-role';
                data.idRole = 2;
            }

            // Mostrar loading
            form.style.display = 'none';
            loadingSpinner.classList.add('active');
            resultMessage.classList.remove('active');

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                // Ocultar loading
                loadingSpinner.classList.remove('active');
                form.style.display = 'block';

                // Mostrar resultado
                if (response.ok) {
                    resultMessage.className = 'result-message success active';
                    resultMessage.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <strong>¬°Env√≠o masivo completado!</strong><br>
                        Correo enviado inmediatamente a ${result.successCount} usuarios<br>
                        <small>El env√≠o masivo se realiz√≥ en una sola operaci√≥n üöÄ</small>
                    `;
                    
                    // Cerrar modal despu√©s de 3 segundos
                    setTimeout(() => {
                        cerrarModalEmail();
                    }, 3000);
                } else {
                    resultMessage.className = 'result-message error active';
                    resultMessage.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Error en el env√≠o</strong><br>
                        ${result.message || 'Ocurri√≥ un error al enviar los correos'}
                    `;
                }
            } catch (error) {
                loadingSpinner.classList.remove('active');
                form.style.display = 'block';
                
                resultMessage.className = 'result-message error active';
                resultMessage.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Error de conexi√≥n</strong><br>
                    No se pudo conectar con el servidor
                `;
                console.error('Error:', error);
            }
        }

        // Funci√≥n para cargar datos desde archivo
        async function cargarDatos(event) {
            event.preventDefault();

            const form = event.target;
            const archivo = document.getElementById('archivoCargaDatos').files[0];
            const loadingCarga = document.getElementById('loadingCarga');
            const resultCarga = document.getElementById('resultCarga');

            if (!archivo) {
                alert('Por favor seleccione un archivo');
                return;
            }

            // Mostrar loading
            form.style.display = 'none';
            loadingCarga.classList.add('active');
            resultCarga.classList.remove('active');

            const formData = new FormData();
            formData.append('archivo', archivo);

            try {
                const response = await fetch('/api/users/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                // Ocultar loading
                loadingCarga.classList.remove('active');
                form.style.display = 'block';

                if (response.ok && result.success) {
                    // Mostrar resultado exitoso
                    resultCarga.className = 'result-message success active';
                    resultCarga.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <strong>¬°Archivo procesado exitosamente!</strong><br>
                        üìä <strong>Resumen de importaci√≥n:</strong><br>
                        ‚úÖ Usuarios creados: ${result.usuariosCreados}<br>
                        üìÅ Total procesados: ${result.totalProcesados}<br>
                        ${result.usuariosDuplicados > 0 ? `‚ö†Ô∏è Usuarios duplicados (omitidos): ${result.usuariosDuplicados}<br>` : ''}
                        ${result.errores && result.errores.length > 0 ?
                            `‚ùå Errores encontrados: ${result.errores.length}<br><small>${result.errores.slice(0, 3).join('<br>')}</small>` :
                            '<small>‚ú® Todos los registros v√°lidos fueron importados</small>'}
                    `;

                    // Recargar la tabla de usuarios despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    // Mostrar error
                    resultCarga.className = 'result-message error active';
                    resultCarga.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Error al procesar archivo</strong><br>
                        ${result.message || 'Ocurri√≥ un error inesperado'}<br>
                        <small>üìã Verifique el formato del archivo y los datos</small>
                    `;
                }

            } catch (error) {
                loadingCarga.classList.remove('active');
                form.style.display = 'block';

                resultCarga.className = 'result-message error active';
                resultCarga.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Error de conexi√≥n</strong><br>
                    No se pudo conectar con el servidor<br>
                    <small>Verifique su conexi√≥n a internet</small>
                `;
                console.error('Error:', error);
            }
        }

        // Funciones existentes
        function exportarUsuariosExcel() {
            const params = new URLSearchParams(window.location.search);
            window.location.href = `/api/users/exportExcel?${params.toString()}`;
        }

        function exportarUsuariosPDF() {
            const params = new URLSearchParams(window.location.search);
            window.location.href = `/api/users/exportPdf?${params.toString()}`;
        }

        function editarUsuario(id) {
            window.location.href = `/editar_usuario/${id}`;
        }

        function eliminarUsuario(id) {
            if (confirm('¬øEst√° seguro de eliminar este usuario?')) {
                fetch(`/api/users/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Usuario eliminado exitosamente');
                        window.location.reload();
                    } else {
                        alert('Error al eliminar usuario');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al eliminar usuario');
                });
            }
        }

        // Cerrar modal con tecla ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                cerrarModalEmail();
                cerrarModalCargaDatos();
            }
        });
    </script>
</body>
</html>