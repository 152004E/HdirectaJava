<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mensajes y comentarios -- HUERTA DIRECTA</title>

    <!-- Link para el font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined"
    />

    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <!-- Enlace al archivo CSS -->
    <link rel="stylesheet" href="/CSS/StyleDashBoardd.css" />
    <link rel="stylesheet" href="/css/output.css" />
    <link rel="icon" type="image/png" href="/images/logo_huerta.png" />
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-overlay.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .modal-email.active {
            display: block;
            animation: slideDown 0.3s;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }
        
        .hidden {
            display: none;
        }

        /* Estilos mejorados para mejor espaciado */
        .stats-section {
            margin-bottom: 3rem !important;
            padding: 2.5rem !important;
        }

        .stats-cards {
            gap: 1.5rem !important;
            margin-bottom: 2.5rem !important;
        }

        .stats-card {
            padding: 2rem 1.5rem !important;
            transition: all 0.3s ease !important;
        }

        .stats-card:hover {
            transform: translateY(-5px) !important;
        }

        .charts-grid {
            gap: 2rem !important;
        }

        .chart-container {
            padding: 2rem !important;
            margin-bottom: 1rem !important;
        }

        .chart-title {
            margin-bottom: 1.5rem !important;
            padding-bottom: 1rem !important;
            border-bottom: 2px solid #f3f4f6 !important;
        }

        .section-title {
            margin-bottom: 2rem !important;
        }

        .icon-large {
            margin-bottom: 1rem !important;
        }

        .stats-number {
            margin: 0.5rem 0 !important;
        }

        .stats-description {
            margin-top: 0.5rem !important;
        }
    </style>
  </head>

  <body>
    <div class="containerActualizarUcuario">
      <div
        th:replace="fragments/DashBoard/insadeDashBoard :: insadeDashBoard"
      ></div>
      <!-- fin del asside -->
      <main>
        <h1 class="!mt-[20px]">Análisis y gráficos de actividad</h1>
        

        <div
          class="flex justify-center items-center gap-20 !my-10 text-xl font-bold !text-black/70"
        >
          <a class="!text-[#8bc34a] !border-b-4 !border-[#88ff002f]" href=""
            >Tus productos</a
          >
          <a href="">Tus ventas</a>
        </div>

        <!-- SECCIÓN DE ESTADÍSTICAS Y GRÁFICAS DE PRODUCTOS -->
        <div class="stats-section bg-gradient-to-br from-green-50 to-emerald-100 rounded-2xl shadow-lg">
            <h2 class="section-title text-3xl font-bold text-gray-800 text-center flex items-center justify-center gap-3">
                <i class="fas fa-chart-line text-green-600"></i> 
                Estadísticas de Productos
            </h2>

            <!-- Tarjetas de Estadísticas -->
            <div class="stats-cards grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4">
                <!-- Total Productos -->
                <div class="stats-card bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border-l-4 border-green-500">
                    <div class="icon-large text-5xl text-green-500 text-center">
                        <i class="fas fa-box"></i>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide text-center mb-2">
                        Total Productos
                    </h3>
                    <div id="totalProducts" class="stats-number text-4xl font-bold text-gray-800 text-center">0</div>
                    <div class="stats-description text-xs text-gray-500 text-center">En el catálogo</div>
                </div>

                <!-- Unidades de Medida -->
                <div class="stats-card bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border-l-4 border-emerald-600">
                    <div class="icon-large text-5xl text-emerald-600 text-center">
                        <i class="fas fa-weight-scale"></i>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide text-center mb-2">
                        Unidades Diferentes
                    </h3>
                    <div id="unitsCount" class="stats-number text-4xl font-bold text-gray-800 text-center">0</div>
                    <div class="stats-description text-xs text-gray-500 text-center">Tipos de medida</div>
                </div>

                <!-- Productos Activos -->
                <div class="stats-card bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border-l-4 border-orange-500">
                    <div class="icon-large text-5xl text-orange-500 text-center">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide text-center mb-2">
                        Productos Activos
                    </h3>
                    <div id="activeProducts" class="stats-number text-4xl font-bold text-gray-800 text-center">0</div>
                    <div class="stats-description text-xs text-gray-500 text-center">Disponibles para venta</div>
                </div>

                <!-- Categorías -->
                <div class="stats-card bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border-l-4 border-lime-500">
                    <div class="icon-large text-5xl text-lime-500 text-center">
                        <i class="fas fa-tags"></i>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide text-center mb-2">
                        Categorías
                    </h3>
                    <div id="categoriesCount" class="stats-number text-4xl font-bold text-gray-800 text-center">0</div>
                    <div class="stats-description text-xs text-gray-500 text-center">Diferentes categorías</div>
                </div>
            </div>

            <!-- Gráficas -->
            <div class="charts-grid grid grid-cols-1 lg:grid-cols-2">
                <!-- Distribución por Unidades de Medida -->
                <div class="chart-container bg-white rounded-xl shadow-md">
                    <h3 class="chart-title text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-balance-scale text-green-600"></i>
                        Distribución por Unidades
                    </h3>
                    <div class="relative h-72">
                        <canvas id="unitsChart"></canvas>
                    </div>
                </div>

                <!-- Distribución por Categorías -->
                <div class="chart-container bg-white rounded-xl shadow-md">
                    <h3 class="chart-title text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-green-600"></i>
                        Productos por Categoría
                    </h3>
                    <div class="relative h-72">
                        <canvas id="categoriesChart"></canvas>
                    </div>
                </div>

                <!-- Tendencia de Precios -->
                <div class="chart-container bg-white rounded-xl shadow-md lg:col-span-2">
                    <h3 class="chart-title text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-chart-line text-green-600"></i>
                        Análisis de Precios
                    </h3>
                    <div class="relative h-72">
                        <canvas id="pricesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIÓN COMENTARIOS -->
        <div class="mt-12">
            <h2 class="section-title text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                <i class="fas fa-comments text-green-600"></i>
                Tus Comentarios
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- Iterar los comentarios --> 
              <div
                th:each="comment : ${comments}"
                class="bg-white rounded-xl shadow-lg p-6 flex flex-col justify-between hover:shadow-2xl transition-all duration-500 hover:scale-[1.03] ease-in-out cursor-pointer group"
              >
                <div class="flex items-start space-x-4 mb-4">
                  <!-- Avatar con iniciales -->
                  <div
                    class="flex-shrink-0 bg-[#8bc34a] w-12 h-12 rounded-full bg-accent flex items-center justify-center"
                  >
                    <span
                      class="text-white text-xl font-bold uppercase"
                      th:text="${#strings.substring(comment.user.name, 0, 1)}"
                    >
                      U
                    </span>
                  </div>

                  <!-- Contenido del comentario -->
                  <div class="flex-1">
                    <div class="flex justify-between items-start">
                      <div>
                        <!-- Tipo de comentario -->
                        <p
                          class="text-lg font-semibold text-gray-900 leading-tight"
                          th:text="${comment.commentType.name() == 'SITE' ? 'Comentario del sitio' : 'Comentario del producto'}"
                        >
                          Comentario del sitio
                        </p>

                        <!-- Nombre y correo -->
                        <p class="text-lg text-gray-500 mt-2">
                          <span class="mr-2"> Tú : </span>

                          <span th:text="${comment.user.name}">
                            María González
                          </span>
                          <span class="hidden sm:inline">
                            •
                            <span th:text="${comment.user.email}">
                              maria.gonzalez@example.com
                            </span>
                          </span>
                        </p>
                      </div>

                      <span
                        class="material-symbols-outlined text-gray-400 ml-2 group-hover:text-primary"
                      >
                        3p
                      </span>
                    </div>

                    <!-- Texto del comentario -->
                    <p
                      class="mt-3 text-gray-700 line-clamp-3 break-all whitespace-normal max-w-[300px]"
                      th:text="${comment.commentCommenter}"
                    >
                      ¡El servicio es increíble! La entrega fue súper rápida y los
                      productos de una calidad excepcional.
                    </p>
                  </div>
                </div>

                <div
                  class="flex justify-around items-center pt-3 text-sm font-medium text-primary mt-8 border-t-2 border-black/10"
                >
                  <!-- Fecha -->
                  <p
                    class="text-[14px] text-gray-500"
                    th:text="${#temporals.format(comment.creationComment, 'dd MMMM yyyy')}"
                  >
                    22 de Octubre, 2025
                  </p>
                  <div class="flex gap-2">
                    <button
                      type="button"
                      class="btn-actualizar"
                      th:attr="onclick='abrirModalComentario(' + ${comment.idComment} + ', `' + ${comment.commentCommenter} + '`)'"
                    >
                      <span class="material-symbols-outlined">edit</span>
                    </button>
                    <button
                      type="button"
                      class="btn-eliminar"
                      th:attr="onclick='confirmarEliminacion(' + ${comment.idComment} + '); return false;'"
                    >
                      <span class="material-symbols-outlined">delete</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
        </div>

        <!--modal para editar el comentario-->
        <div
          id="modalEditarComentario"
          class="fixed inset-0 bg-black/50 bg-opacity-50 hidden justify-center items-center z-50"
        >
          <div
            class="bg-white rounded-xl shadow-xl w-[600px] p-6 relative animate-fadeIn"
          >
            <!-- Botón cerrar -->
            <button
              onclick="cerrarModalComentario()"
              class="absolute top-3 right-3 text-gray-700 hover:text-[#8bc34a] cursor-pointer transition-all duration-500 hover:scale-[1.05]"
            >
              ✕
            </button>
            <div class="flex justify-center items-center h-10">
              <h2
                class="text-2xl font-semibold text-gray-800 mb-10 text-center"
              >
                <span class="material-symbols-outlined mt-2">
                  edit_arrow_down
                </span>
                Edita tu comentario
              </h2>
            </div>

            <form id="formEditarComentario" method="post">
              <input type="hidden" name="idComment" id="idComment" />

              <textarea
                id="commentCommenter"
                name="commentCommenter"
                rows="5"
                placeholder="Escribe tu comentario..."
                required
                class="w-full p-3 border border-gray-400 rounded-md resize-y focus:outline-none focus:ring-2 focus:ring-green-500"
              ></textarea>

              <div class="flex justify-end gap-3 mt-4">
                <button
                  type="button"
                  onclick="cerrarModalComentario()"
                  class="bg-gray-300 text-gray-700 flex justify-center items-center gap-2 px-4 py-2 rounded-lg hover:bg-gray-400 transition-all duration-500 hover:scale-[1.05]"
                >
                  <span class="material-symbols-outlined"> cancel </span>
                  <p>Cancelar</p>
                </button>
                <button
                  type="submit"
                  class="bg-green-600 flex justify-center items-center gap-2 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all duration-500 hover:scale-[1.05]"
                >
                  <span class="material-symbols-outlined"> save_as </span>
                  <p class="text-white">Guardar</p>
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>

      <div class="right">
        <div class="top">
          <div class="theme-toggler">
            <span class="material-symbols-outlined active">light_mode</span>
            <span class="material-symbols-outlined">dark_mode</span>
          </div>
          <div th:replace="fragments/profile :: profile"></div>
        </div>
      </div>
    </div>
    <script src="/JS/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // Variables para las gráficas
        let unitsChart, categoriesChart, pricesChart;

        // Función para obtener datos reales de productos desde la API
        async function obtenerDatosProductos() {
            try {
                const response = await fetch('/api/products');
                if (!response.ok) {
                    throw new Error('Error al obtener productos');
                }
                const productos = await response.json();
                return productos;
            } catch (error) {
                console.error('Error obteniendo productos:', error);
                return [];
            }
        }

        // Función para obtener productos del usuario actual
        async function obtenerMisProductos() {
            try {
                const response = await fetch('/api/products/mis-Productos');
                if (!response.ok) {
                    throw new Error('Error al obtener mis productos');
                }
                const productos = await response.json();
                return productos;
            } catch (error) {
                console.error('Error obteniendo mis productos:', error);
                return [];
            }
        }

        // Función para calcular estadísticas de productos con datos reales
        async function calcularEstadisticasProductos() {
            // Obtener todos los productos del sistema
            const productos = await obtenerDatosProductos();
            
            // Si quieres solo los productos del usuario actual, usa:
            // const productos = await obtenerMisProductos();

            let total = productos.length;
            
            // Asumimos que todos los productos están activos (puedes ajustar según tu lógica de negocio)
            let activos = productos.length;
            
            // Obtener categorías únicas
            const categoriasUnicas = [...new Set(productos.map(p => p.category))];
            const categoriasCount = categoriasUnicas.length;
            
            // Obtener unidades de medida únicas
            const unidadesUnicas = [...new Set(productos.map(p => p.unit))];
            const unidadesCount = unidadesUnicas.length;
            
            // Contar productos por categoría
            const productosPorCategoria = {};
            categoriasUnicas.forEach(cat => {
                productosPorCategoria[cat] = productos.filter(p => p.category === cat).length;
            });

            // Contar productos por unidad de medida
            const productosPorUnidad = {};
            unidadesUnicas.forEach(unidad => {
                productosPorUnidad[unidad] = productos.filter(p => p.unit === unidad).length;
            });

            // Calcular estadísticas de precios
            const precios = productos.map(p => p.price);
            const precioPromedio = precios.length > 0 ? 
                precios.reduce((a, b) => a + b, 0) / precios.length : 0;
            const precioMax = precios.length > 0 ? Math.max(...precios) : 0;
            const precioMin = precios.length > 0 ? Math.min(...precios) : 0;

            return {
                total,
                activos,
                categoriasCount,
                unidadesCount,
                productosPorCategoria,
                productosPorUnidad,
                precios: {
                    promedio: precioPromedio,
                    maximo: precioMax,
                    minimo: precioMin
                },
                productos // Devolvemos los productos para análisis adicionales
            };
        }

        // Actualizar tarjetas de estadísticas
        function actualizarTarjetasProductos(stats) {
            document.getElementById('totalProducts').textContent = stats.total;
            document.getElementById('activeProducts').textContent = stats.activos;
            document.getElementById('categoriesCount').textContent = stats.categoriasCount;
            document.getElementById('unitsCount').textContent = stats.unidadesCount;
        }

        // Inicializar gráficas
        async function inicializarGraficasProductos() {
            const stats = await calcularEstadisticasProductos();
            actualizarTarjetasProductos(stats);

            // Destruir gráficas existentes si las hay
            if (unitsChart) unitsChart.destroy();
            if (categoriesChart) categoriesChart.destroy();
            if (pricesChart) pricesChart.destroy();

            const colors = {
                kilogramos: '#10b981',
                gramos: '#3b82f6',
                libras: '#f59e0b',
                unidad: '#ef4444',
                litros: '#8b5cf6',
                mililitros: '#06b6d4',
                docena: '#84cc16',
                paquete: '#f97316',
                atado: '#ec4899',
                otro: '#6b7280',
                frutas: '#ef4444',
                verduras: '#3b82f6',
                hierbas: '#8b5cf6',
                organicos: '#84cc16',
                lacteos: '#06b6d4',
                cereales: '#f97316'
            };

            // Mapeo de colores para unidades de medida
            const coloresUnidades = {
                'Kilogramos (kg)': colors.kilogramos,
                'Gramos (g)': colors.gramos,
                'Libros (lb)': colors.libras,
                'Unidad (u)': colors.unidad,
                'Litros (L)': colors.litros,
                'Millilitros (ml)': colors.mililitros,
                'Docena': colors.docena,
                'Paquete': colors.paquete,
                'Atado': colors.atado,
                'Otro': colors.otro
            };

            // Mapeo de colores para categorías
            const coloresCategorias = {
                'Frutas': colors.frutas,
                'Verduras': colors.verduras,
                'Hierbas': colors.hierbas,
                'Orgánicos': colors.organicos,
                'Lácteos': colors.lacteos,
                'Cereales': colors.cereales
            };

            // Gráfica de unidades de medida
            const unitsCtx = document.getElementById('unitsChart').getContext('2d');
            const unidadesLabels = Object.keys(stats.productosPorUnidad);
            const unidadesData = Object.values(stats.productosPorUnidad);
            
            // Generar colores para las unidades
            const unidadesColors = unidadesLabels.map(unidad => 
                coloresUnidades[unidad] || `#${Math.floor(Math.random()*16777215).toString(16)}`
            );
            
            unitsChart = new Chart(unitsCtx, {
                type: 'doughnut',
                data: {
                    labels: unidadesLabels,
                    datasets: [{
                        data: unidadesData,
                        backgroundColor: unidadesColors,
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                padding: 15, 
                                font: { size: 11 },
                                usePointStyle: true
                            } 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfica de categorías
            const categoriesCtx = document.getElementById('categoriesChart').getContext('2d');
            const categoriasLabels = Object.keys(stats.productosPorCategoria);
            const categoriasData = Object.values(stats.productosPorCategoria);
            
            // Generar colores para las categorías
            const categoriasColors = categoriasLabels.map(cat => 
                coloresCategorias[cat] || `#${Math.floor(Math.random()*16777215).toString(16)}`
            );
            
            categoriesChart = new Chart(categoriesCtx, {
                type: 'bar',
                data: {
                    labels: categoriasLabels,
                    datasets: [{
                        label: 'Productos por Categoría',
                        data: categoriasData,
                        backgroundColor: categoriasColors,
                        borderRadius: 8,
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false } 
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            ticks: { stepSize: 1 },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Gráfica de análisis de precios
            const pricesCtx = document.getElementById('pricesChart').getContext('2d');
            pricesChart = new Chart(pricesCtx, {
                type: 'line',
                data: {
                    labels: ['Precio Mínimo', 'Precio Promedio', 'Precio Máximo'],
                    datasets: [{
                        label: 'Análisis de Precios ($)',
                        data: [stats.precios.minimo, stats.precios.promedio, stats.precios.maximo],
                        borderColor: '#16a34a',
                        backgroundColor: 'rgba(22, 163, 74, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 8,
                        pointBackgroundColor: '#16a34a',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Precio ($)',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Métricas de Precio',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            inicializarGraficasProductos();
        });

        // Las funciones existentes para comentarios...
        function abrirModalComentario(id, comentario) {
            document.getElementById('idComment').value = id;
            document.getElementById('commentCommenter').value = comentario;
            document.getElementById('modalEditarComentario').classList.remove('hidden');
        }

        function cerrarModalComentario() {
            document.getElementById('modalEditarComentario').classList.add('hidden');
        }

        function confirmarEliminacion(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Aquí va la lógica para eliminar el comentario
                    Swal.fire(
                        'Eliminado!',
                        'El comentario ha sido eliminado.',
                        'success'
                    );
                }
            });
        }
    </script>
  </body>
</html>