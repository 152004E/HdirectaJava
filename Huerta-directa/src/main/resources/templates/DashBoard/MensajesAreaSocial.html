<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mensajes-- HUERTA DIRECTA</title>

    <!-- Link para el font -->

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined"
    />

    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <!-- Enlace al archivo CSS -->
    <link rel="stylesheet" href="/CSS/StyleDashBoardd.css" />
    <link rel="stylesheet" href="/css/output.css" />
    <link rel="icon" type="image/png" href="/images/logo_huerta.png" />
  </head>

  <body>
    <div class="containerActualizarUcuario">
      <div
        th:replace="fragments/DashBoard/insadeDashBoard :: insadeDashBoard"
      ></div>
      <!-- fin del asside -->
      <main>
        <input type="hidden" id="username" th:value="${currentUser.name}" />
        <h1 class="!mt-[20px]">Revisa tus mensajes aqu√≠.</h1>
        <div
          id="NotaComentarios"
          class="bg-yellow-100 !border-l-4 !border-yellow-500 text-yellow-800 !p-4 rounded-md shadow-md !w-full h-18 mx-auto !mt-4 flex justify-between items-center hover:bg-yellow-100/80 transition-all duration-500"
        >
          <p class="text-md">
            <strong>Nota:</strong> Puedes mantener conversaciones con tus
            compradores o vendedores en esta seccion
            <span class="font-semibold"
              >Recuerda que los chats son temporales
            </span>
          </p>
          <button
            id="botonnota"
            class="bg-[#8bc34a] !px-2 !py-1 text-amber-50 cursor-pointer rounded-sm"
          >
            x
          </button>
        </div>

        <div
          class="flex justify-center items-center gap-20 !my-10 text-xl font-bold !text-black/70"
        >
          <a href="" class="!text-[#8bc34a] !border-b-4 !border-[#88ff002f]"
            >Area Social</a
          >
          <a href="">Comentarios de tus productos</a>
          <a th:href="@{/MensajesComentarios}">Tus Comentarios</a>
        </div>
        <!-- SECCI√ìN COMENTARIOS -->

        <div class="!w-3/4 !mx-auto shadow-2xl !rounded-3xl overflow-hidden">
          <div
            class="!bg-white !h-full !w-full !p-3 flex justify-between items-center"
          >
            <h2 class="!text-3xl !font-bold !text-green-700">
              üí¨ Chat √Årea Social
            </h2>
            <div class="flex justify-center items-center !gap-3 !mr-10">
              <label class="!font-semibold !text-gray-700 "
                >Tu nombre:</label
              >
              <p th:text="${currentUser.name}">Nombre</p>
             
            </div>
          </div>

          <!-- NOMBRE DEL USUARIO -->

          <!-- √ÅREA DEL CHAT -->
          <div
            id="chatArea"
            class="!flex !flex-col !h-80 !overflow-y-auto !p-4 !bg-[#FAF2DD] !mb-5"
          ></div>

          <!-- ESCRIBIR MENSAJE -->
          <div class="!flex !gap-3 !p-6 !bg-white justify-center items-center">
            <span class="material-symbols-outlined">add_circle</span>
            <input
              id="content"
              type="text"
              placeholder="Escribe tu mensaje..."
              class="!flex-grow !p-3 shadow-[inset_0_0_6px_rgba(0,0,0,0.4)] !rounded-2xl !focus:outline-none !focus:ring-2 !focus:ring-green-400"
            />

            <button
              onclick="sendMessage()"
              class="!bg-green-600 !h-[40px] cursor-pointer flex justify-center items-center !text-white !px-6 !rounded-lg !font-semibold hover:!bg-green-700 hover:!scale-[1.03] !transition-all !duration-500"
            >
              <p class="!text-white">Enviar</p>
              <span class="material-symbols-outlined">send</span>
            </button>
          </div>
        </div>
      </main>

      <div class="right">
        <div class="top">
          <div class="theme-toggler">
            <span class="material-symbols-outlined active">light_mode</span>
            <span class="material-symbols-outlined">dark_mode</span>
          </div>
          <div th:replace="fragments/profile :: profile"></div>
        </div>
        <div
          class="recent-updates !h-[640px] !border-t !border-black/30 !rounded-xl !px-5"
        >
          <div class="flex flex-col items-center !gap-2 !my-5">
            <div class="flex !gap-2">
              <i class="fa-solid fa-comments text-blue-600 text-[22px]"></i>
              <h3 class="!text-[20px] tracking-wide font-semibold">
                Tus chats
              </h3>
            </div>
          </div>
          <div
            class="!w-full !h-full !max-w-md !mx-auto !bg-white !p-2 !mt-[20px] !rounded-xl"
          >
            <!-- ITEM 1 -->
            <div
              class="!flex !items-center !justify-between !p-3 !hover:bg-gray-100 !cursor-pointer !rounded-lg"
            >
              <div class="!flex !items-center">
                <img
                  src="https://i.pravatar.cc/60?img=1"
                  class="!w-12 !h-12 !rounded-full !object-cover"
                />
                <div class="!ml-3">
                  <p class="!font-semibold !text-gray-800">Ana</p>
                  <p class="!text-gray-500 !text-sm">
                    üõí Vendi√≥: Tomates frescos ‚Äì $12.000
                  </p>
                </div>
              </div>
              <p class="!text-gray-500 !text-xs">11:32</p>
            </div>

            <!-- ITEM 2 -->
            <div
              class="!flex !items-center !justify-between !p-3 !hover:bg-gray-100 !cursor-pointer !rounded-lg"
            >
              <div class="!flex !items-center">
                <img
                  src="https://i.pravatar.cc/60?img=2"
                  class="!w-12 !h-12 !rounded-full !object-cover"
                />
                <div class="!ml-3">
                  <p class="!font-semibold !text-gray-800">Luis</p>
                  <p class="!text-gray-500 !text-sm">
                    üì¶ Nuevo producto: Lechuga Org√°nica
                  </p>
                </div>
              </div>
              <p class="!text-gray-500 !text-xs">10:04</p>
            </div>

            <!-- ITEM 3 -->
            <div
              class="!flex !items-center !justify-between !p-3 !hover:bg-gray-100 !cursor-pointer !rounded-lg"
            >
              <div class="!flex !items-center">
                <img
                  src="https://i.pravatar.cc/60?img=3"
                  class="!w-12 !h-12 !rounded-full !object-cover"
                />
                <div class="!ml-3">
                  <p class="!font-semibold !text-gray-800">Mart√≠n</p>
                  <p class="!text-gray-500 !text-sm">
                    ü•¨ Oferta recibida por: Cilantro fresco
                  </p>
                </div>
              </div>
              <p class="!text-gray-500 !text-xs">9:45</p>
            </div>

            <!-- ITEM 4 -->
            <div
              class="!flex !items-center !justify-between !p-3 !hover:bg-gray-100 !cursor-pointer !rounded-lg"
            >
              <div class="!flex !items-center">
                <img
                  src="https://i.pravatar.cc/60?img=4"
                  class="!w-12 !h-12 !rounded-full !object-cover"
                />
                <div class="!ml-3">
                  <p class="!font-semibold !text-gray-800">Gregorio</p>
                  <p class="!text-gray-500 !text-sm">
                    üçÖ Pedido confirmado: Tomate Chonto
                  </p>
                </div>
              </div>
              <p class="!text-gray-500 !text-xs">9:23</p>
            </div>

            <!-- ITEM 5 -->
            <div
              class="!flex !items-center !justify-between !p-3 !hover:bg-gray-100 !cursor-pointer !rounded-lg"
            >
              <div class="!flex !items-center">
                <img
                  src="https://i.pravatar.cc/60?img=5"
                  class="!w-12 !h-12 !rounded-full !object-cover"
                />
                <div class="!ml-3">
                  <p class="!font-semibold !text-gray-800">Andrea</p>
                  <p class="!text-gray-500 !text-sm">
                    ü•ö Publicaste: Huevos campesinos
                  </p>
                </div>
              </div>
              <p class="!text-green-600 !text-xs !font-semibold">8:37</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="/JS/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- LIBRER√çAS PARA WEBSOCKETS -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
      let stompClient = null;
      let currentUser = null;
      const sender = document.getElementById("username").value;

      function connect() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
          stompClient.subscribe("/topic/messages", function (message) {
            addMessage(JSON.parse(message.body));
          });
        });
      }

      function sendMessage() {
        const sender = document.getElementById("username").value;
        const content = document.getElementById("content").value.trim();

        if (content === "") {
          Swal.fire({
            icon: "warning",
            title: "Mensaje vac√≠o",
            text: "Debes escribir un mensaje.",
            confirmButtonColor: "#3085d6",
          });
          return;
        }

        if (!currentUser) currentUser = sender;

        stompClient.send(
          "/app/sendMessage",
          {},
          JSON.stringify({
            sender: sender,
            content: content,
            time: new Date().toLocaleTimeString(),
          })
        );

        document.getElementById("content").value = "";
      }

      function addMessage(msg) {
        const area = document.getElementById("chatArea");
        const isMine = msg.sender === currentUser;

        // üé® Clases de burbuja
        const bubbleClass = isMine
          ? "!bg-[#10B981] !text-white !self-end !items-end !rounded-xl !rounded-tr-none"
          : "!bg-white text-gray-800 !border !border-gray-900/50 !self-start !rounded-xl !rounded-tl-none";

        // üìå Contenedor general alineado
        const wrapperClass = isMine
          ? "!flex !flex-col  !items-end !mb-2"
          : "!flex !flex-col !items-start !mb-2";

        area.innerHTML += `
    <div class="${wrapperClass}">
      
      <div class="!max-w-[80%]  !py-2 !px-5 !shadow ${bubbleClass}">
        <p class="!text-[12px]  !mb-1"><strong>${msg.sender}</strong></p>
        <p class="!text-[12px]  ">${msg.content}</p>
      </div>

      <p class="!text-[10px] !text-gray-400 !mt-1">${msg.time}</p>
    </div>
  `;

        area.scrollTop = area.scrollHeight;
      }

      connect();
    </script>
  </body>
</html>
